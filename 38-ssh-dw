#!/bin/bash

# =============================================================================
# ########################################################################### #
# =============================================================================

# Set container name and hostname here.
export NOMECONTAINER="ssh-dw"
export docker_repo="urbancompasspony/ssh-dw:latest"

# USE IT ONLY IF NEEDED:
function docker_extras {
# nothing...

# =============================================================================
# ########################################################################### #
# =============================================================================

echo "0" > /dev/null
}

export configfile="/srv/containers.yaml"
export masterfile="/srv/system.yaml"

function check_root {
  [ "$EUID" -ne 0 ] && {
    clear; echo "Execute esse script como Root! Saindo..."
    exit 1
  }
}

function check_macvlan {
  macvlanr=$(docker inspect macvlan 1>/dev/null 2>/dev/null && echo yes || echo no)
  if [ "$macvlanr" = "no" ]; then
    clear; echo "A macvlan não existe! Saindo..."; sleep 3
    exit 0
  else
    echo . >/dev/null
  fi
}

function menu_principal {
  # Adicione mais campos conforme necessário!
  load_config

  form=$(dialog --ok-label "Criar" --title "Novo Container" --form "Nome Sugerido: $NOMECONTAINER" 9 40 0 \
    "Nome:" 1 1 "$NOMECONTAINER" 1 6 30 0 \
    3>&1 1>&2 2>&3 3>&- > /dev/tty)
  [ $? -ne 0 ] && exit

  var1=$(echo "$form" | sed -n 1p)
  NOMECONTAINER="$var1"

  create
}

function load_config {
  # Adicione mais campos conforme necessário!

  [ -f "$configfile" ] || return
  var1=$(yq -r '.container_name' "$configfile")
  [ "$var1" = "null" ] && return
  NOMECONTAINER="$var1"
}

function check_IP {
  [ -f "$masterfile" ]
  myip0=$(yq -r '.Informacoes.IP_LAN_Install' "$masterfile")
  if [ "$myip0" = "null" ]; then
    dialog --title "ERRO" --msgbox "Conflito de IP detectado! \nMude para outro IP." 6 40
    return
  else
    create
  fi
}

function mkdir0 {
  if [ -d "/srv/containers/$NOMECONTAINER" ]; then
    dialog --title "WARNING" --msgbox "Foram identificados dados previamente configurados! \n\nParando e removendo container caso esteja rodando. \n\nSe precisar, apague o conteudo de /srv/$NOMECONTAINER manualmente" 12 50
    if [ $(docker stop "$NOMECONTAINER") ]; then
      docker rm "$NOMECONTAINER"
    else
      clear; echo "O container $NOMECONTAINER não existe ou não foi identificado. Continuando..."
    fi
  else
    mkdir -p "/srv/containers/$NOMECONTAINER"
  fi
}

function save_config {
  sudo touch "$configfile"
  datetime0=$(date +"%d/%m/%Y - %H:%M")
  sudo yq -i ".${NOMECONTAINER}.data = \"${datetime0}\"" "$configfile"
  sudo yq -i ".${NOMECONTAINER}.network = \"host\"" "$configfile"
}

function docker_create {
  docker run -d --privileged --no-healthcheck --restart unless-stopped \
  --name="$NOMECONTAINER" --hostname="$NOMECONTAINER" \
  --network host --add-host=host.docker.internal:host-gateway \
  -v /etc/localtime:/etc/localtime:ro \
  -v /srv/containers/"$NOMECONTAINER"/data:/usr/share \
  "$docker_repo"
}

function create {
  #check_IP
  mkdir0
  save_config
  docker pull "$docker_repo"
  docker_create
  docker_extras
  docker image prune -af
}

check_root
check_macvlan
menu_principal

exit 0
